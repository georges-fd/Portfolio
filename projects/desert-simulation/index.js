function n(e,t,s,i){let o=[[t,i,abs(e)],[t,s,e]];return lerpColor(...o[e<0?0:1])}function p(e,t){let s=floor((red(e)+red(t))/2),i=floor((green(e)+green(t))/2),o=floor((blue(e)+blue(t))/2);return color(s,i,o)}function y(e,t){let s=red(e)-t,i=green(e)-t,o=blue(e)-t;return color(s,i,o)}function _(e,t){let s=p(sunrise_color,e),i=p(night_color,e);return n(t,s,e,i)}var S=[[0,0,0,50],[245,108,66,75],[245,182,66,75],[173,245,66,75],[245,224,66,75]],E=class{constructor(t,s){this.pos=createVector(t,s),this.color=this.get_color(),this.size=5}get_color(){return color(...S[floor(random()*S.length)])}draw_spot(t){fill(n(t,this.color,this.color,color(0,50))),square(this.pos.x,this.pos.y,this.size)}},m=class{constructor(){this.background_seeds=[34,85,141,142,152,196,208],this.backround_vertexes=[],this.sand_spots=[],this.sand_spots_ratio=.05,this.day_color=color(244,164,96),this.night_color=color(94,56,109),this.sunrise_color=color(255,94,41),this.max_entites_height=0}generate_backgound(){let t=-height/3,s=.0017;noiseSeed(this.background_seeds[floor(random()*this.background_seeds.length)]),this.backround_vertexes.push(createVector(0,height));for(let i=0;i<width;i++){let o=s*i,r=noise(o)*t+height-height/4;this.backround_vertexes.push(createVector(i,r)),r>this.max_entites_height&&(this.max_entites_height=r),random()<this.sand_spots_ratio&&(r=random(r+10,height),this.sand_spots.push(new E(i,r)))}this.backround_vertexes.push(createVector(width,height))}draw_background(t){stroke(0),strokeWeight(2),fill(n(t,this.sunrise_color,this.day_color,this.night_color)),beginShape();for(let s of this.backround_vertexes)vertex(s.x,s.y);endShape(CLOSE),noStroke();for(let s of this.sand_spots)s.draw_spot(t)}};var c=class{static MAX_SPEED=1;constructor(){this.noiseX=random(0,1e5),this.maxForce=1,this.velocity=createVector(0),this.acceleration=createVector(0),this.perception_radius=random(20,100)}update(){this.velocity.add(this.acceleration),this.velocity.limit(this.maxSpeed),this.pos.add(this.velocity),this.acceleration.mult(0)}applyForce(t){this.acceleration.add(t)}seek(t){let s=p5.Vector.sub(t,this.pos);s.setMag(this.maxSpeed);let i=p5.Vector.sub(s,this.velocity);return i.limit(this.maxForce),i}wander(){let t=noise(this.noiseX)*TWO_PI*2,s=p5.Vector.fromAngle(t);s.setMag(this.maxForce/10),this.applyForce(s),this.noiseX+=.005}evade(t){return this.followTarget(t).mult(-1)}followTarget(t){let s=t.pos.copy(),i=t.velocity.copy();return i.mult(10),s.add(i),this.seek(s)}boundaries(){let{pos:s,velocity:i,maxSpeed:o,maxForce:r}=this,{x:h,y:a}=s,l=null;h<-20?l=createVector(o,i.y):h>width- -20&&(l=createVector(-o,i.y)),a<background_hills.max_entites_height?l=createVector(i.x,o):a>height- -20&&(l=createVector(i.x,-o)),l&&(l.normalize(),l.mult(o),this.applyForce(p5.Vector.sub(l,i).limit(r)))}get_closest(t,s){let i=1/0,o=null;for(let r=t.length-1;r>=0;r--){let h=this.pos.dist(t[r].pos);if(h<this.size){s(r);continue}h<i&&h<this.perception_radius&&(i=h,o=t[r].pos)}return o}draw(){perception_rings&&perception_rings.checked()&&(push(),translate(this.pos.x,this.pos.y),strokeWeight(2),stroke("red"),noFill(),ellipse(0,0,this.perception_radius),pop())}};var f=class e extends c{static MIN_SCALE=.3;static MAX_SCALE=.5;static MIN_FRUIT_CAPACITY=3;static MAX_FRUIT_CAPACITY=7;constructor(){super();let t=50;this.pos=createVector(random(t,width-t),random(background_hills.max_entites_height,height-t)),this.scale=random(e.MIN_SCALE,e.MAX_SCALE),this.w=30*this.scale,this.h=180*this.scale,this.fruit_capacity=floor(random(e.MIN_FRUIT_CAPACITY,e.MAX_FRUIT_CAPACITY)),this.fruits=this.make_fruits()}make_fruits(){let t=[];for(let s=0;s<this.fruit_capacity;s++)t.push(new u(createVector(random(this.pos.x,this.pos.x+this.w),random(this.pos.y,this.pos.y+this.h-20))));return t}draw(t){let s=color(140,175,40),i=p(sunrise_color,s),o=p(night_color,s);s=n(t,i,s,o),fill(s),push(),translate(this.pos.x,this.pos.y),rect(0,0,this.w,this.h,this.w/2,this.w/2,this.w/10,this.w/10);let r=5*this.w/6;rect(-this.w,5,r,this.w*2+1,r/2,r/2,0,0),rect(-this.w,5+this.w*2,this.w+1,r,0,0,0,this.w/2),rect(7*this.w/6,20,r,this.w*2+1,r/2,r/2,0,0),rect(this.w-1,this.w*2+20,this.w+1,r,0,0,this.w/2,0),pop();for(let h of this.fruits)h.draw(t)}apply_behavior(){this.grow_fruit(.005)}grow_fruit(t){for(let s=this.fruits.length-1;s>=0;s--)if(this.fruits[s].grow_fruit(t),this.fruits[s].s==u.FRUIT_MAX_SIZE){let[i]=this.fruits.splice(s,1);setTimeout(()=>{this.fruits.push(new u(createVector(random(this.pos.x,this.pos.x+this.w),random(this.pos.y,this.pos.y+this.h-20))))},random(1e3,5e3)),i.pos.y=this.pos.y+this.h,i.pos.x=i.pos.x+random(-20,20),foods.push(i)}}},u=class e{static FRUIT_MIN_SIZE=3;static FRUIT_MAX_SIZE=13;constructor(t){this.pos=t,this.s=random(e.FRUIT_MIN_SIZE,e.FRUIT_MAX_SIZE)}grow_fruit(t){this.s+=t,this.s=min(this.s,e.FRUIT_MAX_SIZE),this.s=max(this.s,e.FRUIT_MIN_SIZE)}draw(t){let s=lerpColor(color(219,252,3),color(252,100,3),map(this.s,e.FRUIT_MIN_SIZE,e.FRUIT_MAX_SIZE,0,1));s=_(s,t),noStroke(),fill(s),ellipse(this.pos.x,this.pos.y,this.s,this.s)}};var g=class e extends c{static SCALE_MIN=.5;static SCALE_MAX=3.5;static MAIN_CLOUD_BODY_WIDTH=80;static MAIN_CLOUD_BODY_HEIGHT=40;constructor(t=null){super(),this.pos=t??createVector(random(0,width),random(20,height/5)),this.initial_scale=random(e.SCALE_MIN,e.SCALE_MAX-2),this.set_scale(this.initial_scale),this.acceleration=createVector(0,0),this.velocity=createVector(this.maxSpeed,0),this.wonder_force=1e-4,this.evaporation_absorbtion_factor=random(.001,.002),this.raining_rate=random(.001,.005),this.drops=this.create_rain_drops()}create_rain_drops(){let t=[];for(var s=0;s<200;s++)t[s]=new M;return t}draw(t){for(let r of this.drops)r.update(this.is_raining,this.pos,e.MAIN_CLOUD_BODY_WIDTH*this.scale,this.target_rain),r.draw();let s=color(map(this.scale,e.SCALE_MIN,e.SCALE_MAX,255,135)),i=p(sunrise_color,s),o=p(night_color,s);s=n(t,i,s,o),fill(s),push(),translate(this.pos.x,this.pos.y),scale(this.scale),ellipse(0,0,e.MAIN_CLOUD_BODY_WIDTH,e.MAIN_CLOUD_BODY_HEIGHT),ellipse(-30,0,50,30),ellipse(30,0,50,30),fill(y(s,25)),ellipse(-10,-10,10,5),ellipse(10,-10,10,5),pop()}boundaries(){this.pos.x>width+200&&(this.pos.x=-200),this.pos.x<-300&&(this.pos.x=width+200)}apply_behavior(t){this.wander(),this.absorb_evaporation(t),this.rain()}absorb_evaporation(t){t<=0||this.set_scale(this.scale+this.evaporation_absorbtion_factor)}rain(){if(this.is_raining){if(this.scale>this.initial_scale){this.set_scale(this.scale-this.raining_rate);for(let t of cactuses)this.target_rain>t.pos.y&&t.pos.y>=this.target_rain-t.h&&t.pos.x>this.pos.x-e.MAIN_CLOUD_BODY_WIDTH*this.scale/2&&t.pos.x<this.pos.x+e.MAIN_CLOUD_BODY_WIDTH*this.scale/2&&t.grow_fruit(.05)}else this.is_raining=!1;return}this.scale<e.SCALE_MAX||(this.is_raining=!0,this.target_rain=random(height,height-200))}set_scale(t){t=min(t,e.SCALE_MAX),t=max(t,e.SCALE_MIN),this.scale=t,this.maxSpeed=map(t,e.SCALE_MIN,e.SCALE_MAX,.5,.001)}wander(){let t=noise(this.noiseX)*TWO_PI*2,s=p5.Vector.fromAngle(t);s.setMag(this.wonder_force),this.applyForce(s),this.noiseX+=1e-4,this.pos.y<=20&&this.applyForce(createVector(0,1.4*this.wonder_force)),this.pos.y>height/4&&this.applyForce(createVector(0,-1.4*this.wonder_force))}},M=class{constructor(){this.pos=createVector(),this.keep_falling=!1,this.speed=random(5,10),this.gravity=random(.5,1.2)}draw(){this.keep_falling&&(noStroke(),fill(255),ellipse(this.pos.x,this.pos.y,random(1,5),random(1,5)))}update(t,s,i,o){t&&(this.keep_falling=!0),this.keep_falling&&(this.pos.x==0&&(this.pos.y=s.y,this.pos.x=random(s.x-i/2,s.x+i/2)),this.pos.y=this.pos.y+this.speed*this.gravity,this.pos.y>o&&(this.pos.y=s.y,this.pos.x=random(s.x-i/2,s.x+i/2),t||(this.keep_falling=!1,this.pos.x=0)))}};var d=class e{constructor(t){this.genes=t,this.mutationRate=.01,this.mutationAmount=.0025}crossover(t){let s={};for(let i in this.genes)s[i]=random()<.5?this.genes[i]:t.genes[i];return new e(this.mutateGenes(s))}mutateGenes(t){for(let s in t)random()<=this.mutationRate&&(t[s]=t[s]+random(-this.mutationAmount,this.mutationAmount));return t}};var I=class e extends c{static MIN_METABOLISM=9e-4;static MAX_METABOLISM=.009;static MIN_HEALTH=5;static MAX_HEALTH=12;static MIN_REPRODUCTION_RATE=.05;static MAX_REPRODUCTION_RATE=.2;static MIN_SPEED=.7;static MAX_SPEED=1;static MIN_SIZE=7;static MAX_SIZE=10;static MIN_PERCEPTION_RADIUS=60;static MAX_PERCEPTION_RADIUS=128;constructor(t=null,s=null){super(),this.pos=t||createVector(random(0,width),random(background_hills.max_entites_height,height)),this.balls=[],this.nodecount=50,this.step=1,this.healthy_color=color(136,153,90),this.death_color=color(153,98,90),this.applyDNA(s);for(let i=0;i<this.nodecount;i++)this.balls.push(new w(this.pos.x,this.pos.y+i*this.step,this.healthy_color));this.balls[0].healthy_color=color(227,214,157)}applyDNA(t){let s,i,o,r,h,a;t?{initial_speed:s,size:i,initialperception_radius:o,metabolism:r,max_health:h,reproduction_rate:a}=t.genes:(s=random(e.MIN_SPEED,e.MAX_SPEED),i=random(e.MIN_SIZE,e.MAX_SIZE),o=random(e.MIN_PERCEPTION_RADIUS,e.MAX_PERCEPTION_RADIUS),r=random(e.MIN_METABOLISM,e.MAX_METABOLISM),h=random(e.MIN_HEALTH,e.MAX_HEALTH),a=random(e.MIN_REPRODUCTION_RATE,e.MAX_REPRODUCTION_RATE)),this.dna=t||new d({initial_speed:s,size:i,initialperception_radius:o,metabolism:r,max_health:h,reproduction_rate:a}),this.initial_speed=s,this.maxSpeed=this.initial_speed,this.velocity=new createVector(this.maxSpeed,0),this.size=i,this.initialperception_radius=o,this.perception_radius=this.initialperception_radius,this.metabolism=r,this.max_health=h,this.cur_health=this.max_health,this.reproduction_rate=a}draw(t){super.draw();for(let s=this.balls.length-1;s>=0;s--)this.balls[s].draw(this.velocity,t,this.death_color,this.cur_health,this.max_health,this.size)}update(t){t<=0?(this.perception_radius=this.initialperception_radius*1.5,this.cur_health-=this.metabolism*1.3,this.maxSpeed+=.01,this.maxSpeed=min(c.MAX_SPEED,this.maxSpeed)):(this.perception_radius=this.initialperception_radius,this.cur_health-=this.metabolism*.5,this.maxSpeed-=.01,this.maxSpeed=max(this.initial_speed,this.maxSpeed));for(let s=0;s<this.balls.length;s++){this.balls[s].prevpos=this.balls[s].pos;let i=s==0?this.pos:this.balls[s-1].prevpos;this.balls[s].pos=p5.Vector.lerp(this.balls[s].pos,i,this.velocity.mag()),s==this.balls.length-1&&(this.temppos=this.balls[s].prevpos)}super.update()}apply_behavior(){this.wander(),this.seek_rats(),this.reproduce()}reproduce(){this.get_closest(snakes,t=>{if(this!==snakes[t]&&this.cur_health>=.8*this.max_health&&random()<=(this.reproduction_rate+snakes[t].reproduction_rate)/2){let s=new e(createVector((this.pos.x+snakes[t].pos.x)/2,(this.pos.y+snakes[t].pos.y)/2),this.dna.crossover(snakes[t].dna));s.cur_health=s.cur_health/2,snakes.push(s),this.cur_health=this.cur_health/2,snakes[t].cur_health=snakes[t].cur_health/2}})}seek_rats(){let t=this.get_closest(rats,s=>{this.cur_health+=.8,rats.splice(s,1),this.grow()});t&&this.applyForce(this.seek(t))}grow(){this.size+=1,this.balls.push(new w(this.temppos.x,this.temppos.y,this.healthy_color)),this.nodecount++}},w=class{constructor(t,s,i){this.pos=createVector(t,s),this.healthy_color=i,this.prevpos=this.pos}draw(t,s,i,o,r,h){let a=t.heading(),l=lerpColor(i,this.healthy_color,map(o,0,r,0,1));l=_(l,s),push(),translate(this.pos.x,this.pos.y),rotate(a),fill(l),noStroke(),ellipse(0,0,h,h*.7),pop()}};var A=class e extends c{static MIN_METABOLISM=2e-4;static MAX_METABOLISM=.002;static MIN_HEALTH=2.5;static MAX_HEALTH=6;static MIN_REPRODUCTION_RATE=.3;static MAX_REPRODUCTION_RATE=.6;static MIN_SPEED=.3;static MAX_SPEED=1;static MIN_SIZE=7;static MAX_SIZE=12;static MIN_PERCEPTION_RADIUS=40;static MAX_PERCEPTION_RADIUS=110;constructor(t=null,s=null){super(),this.applyDNA(s),this.pos=t||createVector(random(0,width),random(background_hills.max_entites_height,height)),this.healthy_color=color(255,239,204),this.death_color=color(153,102,99)}applyDNA(t){let s,i,o,r,h,a;t?{initial_speed:s,size:i,perception_radius:o,reproduction_rate:r,metabolism:h,max_health:a}=t.genes:(s=random(e.MIN_SPEED,e.MAX_SPEED),i=random(e.MIN_SIZE,e.MAX_SIZE),o=random(e.MIN_PERCEPTION_RADIUS,e.MAX_PERCEPTION_RADIUS),r=random(e.MIN_REPRODUCTION_RATE,e.MAX_REPRODUCTION_RATE),h=random(e.MIN_METABOLISM,e.MAX_METABOLISM),a=random(e.MIN_HEALTH,e.MAX_HEALTH)),this.dna=t||new d({initial_speed:s,size:i,perception_radius:o,reproduction_rate:r,metabolism:h,max_health:a}),this.initial_speed=s,this.maxSpeed=this.initial_speed,this.size=i,this.velocity=new createVector(this.maxSpeed,0),this.perception_radius=o,this.reproduction_rate=r,this.metabolism=h,this.max_health=a,this.cur_health=this.max_health*.5}draw(t){super.draw();let s=this.velocity.heading(),i=lerpColor(this.death_color,this.healthy_color,map(this.cur_health,0,this.max_health,0,1));i=_(i,t),push(),translate(this.pos.x,this.pos.y),rotate(s),fill(i),noStroke(),ellipse(0,0,this.size,this.size*.7),pop()}update(t){super.update(),t>0?(this.cur_health-=this.metabolism,this.maxSpeed+=.01,this.maxSpeed=min(c.MAX_SPEED,this.maxSpeed)):(this.cur_health-=this.metabolism*1.3,this.maxSpeed-=.01,this.maxSpeed=max(this.initial_speed*.8,this.maxSpeed))}apply_behavior(){this.wander(),this.flee_snake(),this.seek_food(),this.reproduce()}reproduce(){this.get_closest(rats,t=>{if(this!==rats[t]&&this.cur_health>=.8*this.max_health&&random()<=(this.reproduction_rate+rats[t].reproduction_rate)/2){let s=new e(createVector((this.pos.x+rats[t].pos.x)/2,(this.pos.y+rats[t].pos.y)/2),this.dna.crossover(rats[t].dna));s.cur_health=s.cur_health/2,rats.push(s),this.cur_health=this.cur_health/2,rats[t].cur_health=rats[t].cur_health/2}})}seek_food(){let t=this.get_closest(foods,s=>{this.cur_health=this.cur_health*1.6,this.size+=1,foods.splice(s,1)});t&&(this.cur_health>=this.max_health*.8?this.applyForce(this.seek(t).mult(-1)):this.applyForce(this.seek(t)))}flee_snake(){let t=1/0,s=null;for(let i=0;i<snakes.length;i++){let o=this.pos.dist(snakes[i].pos)+snakes[i].size;o>=this.perception_radius||o>=t||(t=o,s=snakes[i].pos)}s&&this.applyForce(this.seek(s).mult(-1))}};var T=3,k=12,b=4,N=35;window.cactuses=[];window.clouds=[];window.foods=[];window.snakes=[];window.rats=[];window.background_hills=null;window.day_color=null;window.night_color=null;window.sunrise_color=null;window.perception_rings=null;window.stats=null;window.setup=function(){createCanvas(displayWidth,displayHeight*78/100),perception_rings=createCheckbox("Perception Rings"),stats=createSpan(),window.day_color=color(150,220,255),window.night_color=color(0,0,50),window.sunrise_color=color(252,194,126),window.background_hills=new m,window.background_hills.generate_backgound();for(let e=0;e<k;e++)cactuses.push(new f);for(let e=0;e<T;e++)clouds.push(new g);for(let e=0;e<b;e++)snakes.push(new I);for(let e=0;e<N;e++)rats.push(new A)};window.draw=function(){let e=cos(frameCount/500);background(n(e,sunrise_color,day_color,night_color)),background_hills.draw_background(e),x(rats,e),x(snakes,e),x(cactuses,e),x(clouds,e);for(let t of foods)t.draw(e);stats.html(`Snakes: ${snakes.length} | Rats: ${rats.length} | Food: ${foods.length}`)};function x(e,t){for(let s=e.length-1;s>=0;s--)e[s].boundaries(),e[s].update(t),e[s].apply_behavior(t),e[s].draw(t),e[s].cur_health<0&&e.splice(s,1)}
